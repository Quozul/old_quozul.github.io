<!DOCTYPE html>
<html>

    <head>
        <meta charset='utf-8'>
        <title>Guess the color game</title>
        <link href="style.css" rel="stylesheet" type="text/css">
        <meta name="viewport" content="width=device-width, user-scalable=no">
    </head>

    <body>

        <header>
            <nav>
                <ul id="menu">
                    <li><a href="index.html">Guess the color</a></li>
                    <li class="right"><a href="about.html">About</a></li>
                </ul>
            </nav>
        </header>

        <main class="wrapper">
            <h1 id="guess">Guess the color</h1>
            <div id="info">
                <nobr>
                    rgb
                    <span id="color-code">
                        (<span class="red">0</span>, <span class="green">0</span>, <span class="blue">0</span>)
                    </span>
                </nobr>
                <nobr>
                    <span id="diff-span">
                        Difficulty: <span id="difficulty">0</span>
                    </span>
                    <span id="reset" title="Reset progress">â†»</span>
                    <br>
                    <span>
                        Win rate: <span id="win-rate">??</span>%
                    </span>
                </nobr>
            </div>

            <div id="colors">
                <span class="color-circle" id="1">&nbsp;</span>
                <span class="color-circle" id="2">&nbsp;</span>
                <span class="color-circle" id="3">&nbsp;</span>
                <span class="color-circle" id="4">&nbsp;</span>
                <span class="color-circle" id="5">&nbsp;</span>
            </div>
        </main>

        <footer>
            <copyleft></copyleft> Copyleft Erwan L.<br>
            <h6><b>Note:</b> By playing the game you accept that a cookie is used to store your game data on your
                device.</h6>
        </footer>

        <script>
            let color;
            let colors;
            let dif = 255;
            let guess_timer;
            let win_timer;
            let g_anim;
            let won = false;
            let clicks = 0;
            let wins = 0;

            const win_sound = new Audio('win.mp3');
            const wrong_sound = new Audio('wrong.mp3');
            const circles = document.getElementsByClassName('color-circle');
            const cookie_name = 'gtcgame';

            const win_msg = ['Well done!', 'Good job!', 'So smart!'];
            const encouraging = ['Don\'t give up.', 'Never give up.', 'You can do it.'];

            function rand(l = 0, u = 1) {
                return Math.random() * u + l;
            }

            function d(base, dif) {
                let min_dif = dif / 2;
                let max_dif = dif;

                let c = [];

                base.forEach((v, i) => {
                    let x = rand(-min_dif, max_dif);
                    x = Math.floor(255 - x < 0 ? 255 + (255 - x) : x);

                    c[i] = Math.min(Math.max(v + x, 0), 255);
                });

                return c;
            }

            function e(a, base) {
                for (var i = 0; i < a.length; i++)
                    if (a[i] != base[i])
                        return false;
                return true;
            }

            function randomColor() {
                color = [Math.floor(rand(0, 255)), Math.floor(rand(0, 255)), Math.floor(rand(0, 255))];
                let circle = Math.floor(rand(0, 5));

                for (index in circles)
                    if (circles.hasOwnProperty(index)) {
                        const element = circles[index];

                        if (index == circle)
                            element.style.backgroundColor = `rgb(${color[0]}, ${color[1]}, ${color[2]})`;
                        else {
                            let new_color;
                            do {
                                new_color = d(color, dif);

                                element.style.backgroundColor = `rgb(${new_color[0]}, ${new_color[1]}, ${new_color[2]})`;
                                // element.style.backgroundColor = `rgb(0, 0, 0)`;
                            } while (e(new_color, color));
                        }
                    }

                document.getElementById('color-code').innerHTML = `(<span class="red">${color[0]}</span>, <span class="green">${color[1]}</span>, <span class="blue">${color[2]}</span>)`;
            }

            function verifyColor() {
                if (won) return

                clicks++;

                const g = document.getElementById('guess');
                if (e(this.style.backgroundColor.slice(4, -1).split(', '), color)) {
                    g.innerHTML = win_msg[Math.floor(rand(0, win_msg.length))];

                    anim1();
                    win_sound.play();

                    won = true;
                    wins++;

                    if (win_timer != undefined) clearTimeout(win_timer);

                    // wait 1s till the animation ends and randomize colors
                    win_timer = setTimeout(function () {
                        dif = Math.max(dif - 1, 8);
                        randomColor();
                        document.getElementById('difficulty').innerHTML = 255 - dif;
                        won = false;
                    }, 1000);

                } else {
                    anim2();
                    wrong_sound.play();
                    g.innerHTML = encouraging[Math.floor(rand(0, encouraging.length))];
                }

                document.getElementById('win-rate').innerHTML = Math.round(wins / clicks * 100);

                // resets text after 1s
                if (guess_timer != undefined) clearTimeout(guess_timer);
                guess_timer = setTimeout(function () {
                    g.innerHTML = 'Guess the color';
                }, 1000);

                document.cookie = `${cookie_name}=${JSON.stringify({ dif: dif, clicks: clicks, wins: wins })}`;
                updateText();
            }

            function logColors() {
                for (index in circles)
                    if (circles.hasOwnProperty(index))
                        console.log(parseInt(index) + 1, circles[index].style.backgroundColor);
            }

            function logAnswer() {
                for (index in circles)
                    if (circles.hasOwnProperty(index))
                        if (e(circles[index].style.backgroundColor.slice(4, -1).split(', '), color))
                            console.log(parseInt(index) + 1);
            }

            // click on the circle to toggle verification
            document.body.onload = randomColor;
            document.getElementById('difficulty').innerHTML = 255 - dif;
            for (index in circles)
                if (circles.hasOwnProperty(index))
                    circles[index].onclick = verifyColor;

            // press a number between 1-5 to toggle verification
            document.addEventListener('keydown', function (event) {
                let circle = document.getElementById(event.key);
                if (circle != undefined)
                    verifyColor.call(circle);
            });

            function anim2() {
                if (g_anim != undefined)
                    clearTimeout(g_anim);

                document.getElementById('guess').style.transform = 'scale(1.1)';
                g_anim = setTimeout(function () {
                    document.getElementById('guess').style.transform = '';
                }, 1000);
            }

            function anim1() {
                for (index in circles)
                    if (circles.hasOwnProperty(index)) {
                        const element = circles[index];
                        setTimeout(function () {
                            element.style.borderRadius = '16px';
                            setTimeout(function () {
                                element.style.borderRadius = '';
                            }, 200);
                        }, index * 200);
                    }

                anim2();
            }

            document.getElementById('reset').onclick = function () {
                document.cookie = `${cookie_name}=${JSON.stringify({ dif: 255, clicks: 0, wins: 0 })}`;
                updateText();
                randomColor();
            }

            function updateText() {
                if (document.cookie == '') return;
                // load cookie
                let cookie = JSON.parse(document.cookie.replace(/(?:(?:^|.*;\s*)gtcgame\s*\=\s*([^;]*).*$)|^.*$/, '$1'));
                wins = cookie.wins || 0;
                clicks = cookie.clicks || 0;
                dif = cookie.dif || 255;

                document.getElementById('difficulty').innerHTML = 255 - dif;
                document.getElementById('win-rate').innerHTML = Math.round(wins / clicks * 100) || '??';
            }

            updateText();
        </script>
    </body>

</html>